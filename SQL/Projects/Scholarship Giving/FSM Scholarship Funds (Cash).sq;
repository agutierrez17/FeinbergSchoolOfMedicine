WITH CURRENT_FY AS
(SELECT CASE WHEN EXTRACT(MONTH FROM SYSDATE) >= 9
THEN EXTRACT(YEAR FROM SYSDATE)+1
ELSE EXTRACT(YEAR FROM SYSDATE)
END CFY
FROM DUAL
)

SELECT
E.ID_NUMBER AS "ID Number",
E.PREF_MAIL_NAME AS "Preferred Mail Name",
CASE WHEN G.TRANSACTION_GROUP_SID = 10 AND G.TRANSACTION_TYPE_SID = 0 THEN TG.TRANSACTION_SUB_GROUP_DESC WHEN G.PRIMARY_PLEDGE_SID > 0 AND G.TRANSACTION_TYPE_SID = 0 THEN PP.PLEDGE_TYPE_DESC ELSE T.TRANSACTION_TYPE_DESC END AS "Type of Transaction",
G.TRANS_ID_NUMBER AS "Transaction ID",
TO_CHAR(TO_DATE(G.DATE_OF_RECORD_KEY,'YYYYMMDD'),'Mon DD, YYYY') AS "Commitment Date(mmddyyyy)",
TO_CHAR(TO_DATE(G.RECEIPT_DATE_KEY,'YYYYMMDD'),'Mon DD, YYYY') AS "Receipt Date(mmddyyyy)", 
G.YEAR_OF_GIVING AS "Fiscal Year",
CASE WHEN G.DATE_OF_RECORD_KEY >= '20120901' THEN G.NEW_GIFTS_AND_CMIT_AMT ELSE 0 END AS "New Gifts and Commitments",
CASE 
  WHEN TG.TRANSACTION_SUB_GROUP_CODE IN ('GC') AND RECEIPT_DATE_KEY >= '20120901' THEN G.OUTRIGHT_GIFT_AMOUNT
  WHEN TG.TRANSACTION_SUB_GROUP_CODE IN ('YC') AND RECEIPT_DATE_KEY >= '20120901' THEN G.PLEDGE_PAYMENT_AMOUNT
  WHEN TG.TRANSACTION_SUB_GROUP_CODE IN ('MC') AND RECEIPT_DATE_KEY >= '20120901' THEN G.MATCHING_GIFT_AMOUNT
  ELSE 0 END AS "Cash",
AL.ALLOCATION_CODE AS "Allocation Code",
AL.LONG_NAME AS "Allocation Long Name",
--P.PROGRAM_DESC AS "Program",
AL.AGENCY_CODE_DESC AS "Tier 1 Purpose",
AL.ALLOC_PURPOSE_DESC AS "Tier 2 Purpose",
AL.ALLOC_DEPT_CODE,
AL.ALLOC_DEPT_DESC
FROM DM_ARD.FACT_GIVING_TRANS@catrackstobi G
--INNER JOIN CURRENT_FY ON G.YEAR_OF_GIVING = CURRENT_FY.CFY
INNER JOIN DM_ARD.DIM_TRANSACTION_GROUP@catrackstobi TG ON G.TRANSACTION_GROUP_SID = TG.TRANSACTION_GROUP_SID AND TG.TRANSACTION_SUB_GROUP_CODE IN ('GC','YC','MC')
LEFT OUTER JOIN DM_ARD.DIM_ENTITY@catrackstobi E ON G.ENTITY_ID_NUMBER = E.ID_NUMBER AND E.CURRENT_INDICATOR = 'Y'
LEFT OUTER JOIN DM_ARD.DIM_TRANSACTION_TYPE@catrackstobi T ON G.TRANSACTION_TYPE_SID = T.TRANSACTION_TYPE_SID
LEFT OUTER JOIN DM_ARD.DIM_ALLOCATION@catrackstobi AL ON G.ALLOCATION_SID = AL.ALLOCATION_SID
LEFT OUTER JOIN DM_ARD.DIM_PRIMARY_PLEDGE@catrackstobi PP ON G.PRIMARY_PLEDGE_SID = PP.PRIMARY_PLEDGE_SID 
LEFT OUTER JOIN DM_ARD.DIM_TRANSACTION_GROUP@catrackstobi TG ON G.TRANSACTION_GROUP_SID = TG.TRANSACTION_GROUP_SID
--LEFT OUTER JOIN DM_ARD.DIM_PROGRAM@catrackstobi P ON G.PROGRAM_SID = P.PROGRAM_SID AND P.DELETED_FLAG = 'N'
WHERE
G.REPORTING_AREA_SID = '21' ---- FEINBERG
AND
G.APPEAL_SID NOT IN (17710,17711) ----- EXCLUDE AFFIL, HOSPF, BLANK APPEALS
AND
(G.DATE_OF_RECORD_KEY >= '20120901' OR G.RECEIPT_DATE_KEY >= '20120901')
AND
(
AL.ALLOC_PURPOSE_CODE IN (
'S4', -- Graduate Scholarships, Operating
'S5', -- Graduate Scholarships, Endowed
'S6', -- Graduate Scholarships, Prizes
'PRZ', -- Prizes
'S', -- Scholarships
'SFA', -- Scholarships/Fellowships: Athletics
'SFO', -- Scholarships/Fellowships: General
'SFG', -- Scholarships/Fellowships: Graduate
'SLN', -- Student Loans
'S2' -- Undergrad Scholarships,Endowed
)
OR
AL.ALLOCATION_CODE IN (
'4104000462101END',
'4104000473001END',
'4104000484701END',
'4104000491601END',
'4104000502601END',
'4104000504701END',
'4104000508601END',
'4104000526201END',
'4104000527801END',
'4104001012501END',
'4104001974501END',
'4104002133801END',
'4104002139101END',
'4104002149501END',
'4104002292701END',
'4104002806001END',
'4104002808801END',
'4104002815901END',
'4104002851401END',
'4104002866801END',
'4104002979001END',
'4104003072201END',
'4104003147701END',
'4104003214801END',
'4104003232501END',
'4104003266301END',
'4104003323601END',
'4104003331601END',
'4104003360001END',
'4104003363301END',
'4104003373001END',
'4104003420601END',
'4104003437501END',
'4104003458701END',
'4104003485501END',
'4104003501201END',
'4104003518801END',
'4104003521901END',
'4104003524901END',
'4104003545701END',
'4104003587401END',
'4104003587901END',
'4104003589701END',
'4104003591801END',
'4104003594401END',
'4104003617501END',
'4104003621701END',
'4104003623401END',
'4104003629401END',
'4104003649401END',
'4104003679901END',
'4104003685001END',
'4104003743801END',
'4104003749801END',
'4104003764701END',
'4104003877801END',
'4104003884801END',
'4104003908601END',
'4104004272001END',
'4104004335301END',
'4104004392001END',
'4104004400601END',
'4104004571001END',
'4104004578101END',
'4104004598701END',
'4104004618801END',
'4104004657701END',
'4104004680201END',
'4104004725701END',
'4104004795201END',
'4104004795301END',
'4104004795601END',
'4104004845401END',
'4104004929501END',
'4104004949601END',
'4104004949701END',
'4104005035101END',
'4104005177801END',
'4104006418801END',
'4204000091001EN1',
'4314000078401END',
'4314000114501END',
'4314000516101END',
'4314000528001END',
'4314001972501END',
'4314003214601END',
'4314003321501END',
'4314003328401END',
'4314003331601END',
'4314003604801END',
'4314003623401END',
'4314003632001END',
'4314005064201END',
'4104005483701END',
'4104005747701END',
'3203005619801GFT',
'3203005582701GFT',
'4104005336901END',
'3203005284501GFT',
'4104005916001END'
))
AND
AL.ALLOC_DEPT_CODE NOT IN ('5254100','5254000','5072003')
AND
AL.ALLOCATION_CODE LIKE '320%'
AND
AL.ALLOC_DEPT_CODE = '5011050'
AND
AL.ALLOCATION_CODE IN ('3203004510501GFT')
--AND
--E.PREF_MAIL_NAME LIKE '%Cook%'

ORDER BY
G.DATE_OF_RECORD_KEY DESC,
"New Gifts and Commitments" DESC
